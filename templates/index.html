<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Transporte</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#pedido-form').on('submit', function(e) {
                e.preventDefault();
                var formData = new FormData(this);
                
                $.ajax({
                    url: '/procesar_pedido',
                    type: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function(response) {
                        console.log('Respuesta del servidor:', response);
                        try {
                            $('#resultados').html(formatResults(response));
                        } catch (error) {
                            console.error('Error al formatear resultados:', error);
                            $('#resultados').html('<p>Error al procesar los resultados. Por favor, revise la consola para más detalles.</p>');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error en la solicitud AJAX:', status, error);
                        $('#resultados').html('<p>Error: ' + (xhr.responseJSON ? xhr.responseJSON.error : error) + '</p>');
                    }
                });
            });

            function formatResults(results) {
                console.log('Formateando resultados:', results);
                if (!results || results.length === 0) {
                    return '<p>No se encontraron resultados.</p>';
                }

                let html = '<h2>Resultados del Pedido</h2>';
                let totalEnvios = {
                    'Palet': 0,
                    'XS': 0,
                    'Especial': 0
                };

                results.forEach((envio, index) => {
                    html += `<h3>Envío ${index + 1} - ${envio.tipo}</h3>`;
                    totalEnvios[envio.tipo]++;

                    if (envio.error) {
                        html += `<p>Error: ${envio.error}</p>`;
                        return;
                    }

                    if (envio.tipo === 'Especial') {
                        html += `<p>${envio.mensaje}</p>`;
                    } else {
                        html += `<p>Peso: ${envio.peso ? envio.peso.toFixed(2) : 'N/A'} kg</p>`;
                        html += `<p>Volumen: ${envio.volumen ? envio.volumen.toFixed(2) : 'N/A'} m³</p>`;

                        if (envio.transportista_optimo) {
                            html += `<p>Transportista más barato: ${envio.transportista_optimo} (${envio.tarifa_optima ? envio.tarifa_optima.toFixed(2) : 'N/A'}€)</p>`;
                        } else {
                            html += `<p>No se encontró un transportista óptimo.</p>`;
                        }

                        if (envio.tarifas) {
                            html += '<h4>Tarifas:</h4><ul>';
                            for (let transportista in envio.tarifas) {
                                let tarifa = envio.tarifas[transportista];
                                if (tarifa !== null && !isNaN(tarifa)) {
                                    html += `<li>${transportista}: ${tarifa.toFixed(2)}€</li>`;
                                } else {
                                    html += `<li>${transportista}: No disponible</li>`;
                                }
                            }
                            html += '</ul>';
                        }
                    }

                    if (envio.productos && Array.isArray(envio.productos)) {
                        html += '<h4>Productos:</h4><ul>';
                        envio.productos.forEach(prod => {
                            html += `<li>SKU: ${prod.SKU}, Cantidad: ${prod.CANTIDAD}</li>`;
                        });
                        html += '</ul>';
                    } else {
                        console.warn('Productos no encontrados o no es un array:', envio.productos);
                        html += '<p>Productos no disponibles</p>';
                    }
                });

                html += '<h3>Resumen de Envíos</h3>';
                html += `<p>Palets: ${totalEnvios['Palet']}</p>`;
                html += `<p>XS: ${totalEnvios['XS']}</p>`;
                html += `<p>Especiales: ${totalEnvios['Especial']}</p>`;

                return html;
            }
        });
    </script>
</head>
<body>
    <h1>Calculadora de Transporte</h1>
    
    <h2>Cargar Pedido</h2>
    <form id="pedido-form" enctype="multipart/form-data">
        <label for="provincia">Provincia:</label>
        <select name="provincia" id="provincia" required>
            {% for provincia in provincias %}
                <option value="{{ provincia }}">{{ provincia }}</option>
            {% endfor %}
        </select><br><br>
        <label for="file">Archivo de Pedido:</label>
        <input type="file" name="file" id="file" accept=".csv,.xlsx,.xls" required><br><br>
        <button type="submit">Procesar Pedido</button>
    </form>

    <div id="resultados"></div>

    <h2>Calcular Devolución</h2>
    <form method="POST" action="/calcular_devolucion">
        <label for="provincia-devolucion">Provincia:</label>
        <select name="provincia" id="provincia-devolucion" required>
            {% for provincia in provincias %}
                <option value="{{ provincia }}">{{ provincia }}</option>
            {% endfor %}
        </select><br><br>

        <label for="sku">SKU del Producto:</label>
        <input type="text" name="sku" id="sku" required><br><br>

        <label for="cantidad">Cantidad:</label>
        <input type="number" name="cantidad" id="cantidad" required min="1"><br><br>

        <input type="submit" value="Calcular Devolución">
    </form>

    {% if resultado_devolucion %}
        <h2>Resultado de la Devolución</h2>
        <ul>
        {% for transportista, tarifa in resultado_devolucion.items() %}
            <li>{{ transportista }}: {{ tarifa|round(2) }}€</li>
        {% endfor %}
        </ul>
    {% endif %}

    {% if error %}
        <h2>Error</h2>
        <p>{{ error }}</p>
    {% endif %}
</body>
</html>